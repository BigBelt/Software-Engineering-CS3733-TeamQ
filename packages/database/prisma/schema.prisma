// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  output     = "../.prisma/client"
  engineType = "binary"
}

generator zod {
  provider = "zod-prisma"
  output   = "../zod" // (default) the directory where generated zod schemas will be saved

  relationModel = true // (default) Create and export both plain and related models.
  // relationModel         = "default" // Do not export model without relations.
  // relationModel         = false // Do not generate related model

  modelCase = "PascalCase" // (default) Output models using pascal case (ex. UserModel, PostModel)
  // modelCase             = "camelCase" // Output models using camel case (ex. userModel, postModel)

  modelSuffix = "Model" // (default) Suffix to apply to your prisma models when naming Zod schemas

  // useDecimalJs          = false // (default) represent the prisma Decimal type using as a JS number
  useDecimalJs = true // represent the prisma Decimal type using Decimal.js (as Prisma does)

  // https://www.prisma.io/docs/concepts/components/prisma-client/working-with-fields/working-with-json-fields#filtering-by-null-values
  prismaJsonNullability = true // (default) uses prisma's scheme for JSON field nullability
  // prismaJsonNullability = false // allows null assignment to optional JSON fields
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

model Node {
  id           String        @id
  x            Int
  y            Int
  building     String
  floor        String
  type         NodeType
  longName     String
  shortName    String
  available    Boolean       @default(true)
  outgoing     Edge[]        @relation(name: "NodeOutgoingEdge")
  incoming     Edge[]        @relation(name: "NodeIncomingEdge")
  service      Service[]     @relation(name: "ServiceToNode")
  patients     Patient[]     @relation(name: "PatientToNode")
  appointments Appointment[] @relation(name: "AppointmentToNode")
}

enum NodeType {
  HALL
  ELEV
  REST
  STAI
  DEPT
  LABS
  INFO
  CONF
  EXIT
  RETL
  SERV
}

model Edge {
  startNodeId String
  endNodeId   String
  startNode   Node   @relation(name: "NodeOutgoingEdge", fields: [startNodeId], references: [id], onDelete: Cascade)
  endNode     Node   @relation(name: "NodeIncomingEdge", fields: [endNodeId], references: [id], onDelete: Cascade)

  @@id(name: "edgeId", [startNodeId, endNodeId])
}

model Service {
  id       String      @id @default(uuid())
  nodeId   String
  node     Node        @relation(name: "ServiceToNode", fields: [nodeId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  priority String
  date     DateTime    @default(now())
  login    String
  status   String
  type     ServiceType
  note     String
  flower   Flower?     @relation(name: "FlowerToService")
  gift     Gift?       @relation(name: "GiftToService")
  room     Room?       @relation(name: "RoomToService")
  security Security?   @relation(name: "SecurityToService")
  av       AV?         @relation(name: "AVToService")
}

enum ServiceType {
  flower
  gift
  room
  security
  av
}

model Flower {
  id            String  @id @default(uuid())
  serviceId     String  @unique
  service       Service @relation(name: "FlowerToService", fields: [serviceId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  flower        String
  recipientName String
}

model Gift {
  id            String  @id @default(uuid())
  serviceId     String  @unique
  service       Service @relation(name: "GiftToService", fields: [serviceId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  type          String
  recipientName String
  wrapping      Boolean
  message       String
}

model Room {
  id        String   @id @default(uuid())
  serviceId String   @unique
  service   Service  @relation(name: "RoomToService", fields: [serviceId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  checkIn   DateTime
  checkOut  DateTime
}

model Security {
  id        String   @id @default(uuid())
  serviceId String   @unique
  service   Service  @relation(name: "SecurityToService", fields: [serviceId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  dateTime  DateTime
  threat    String
}

model AV {
  id        String   @id @default(uuid())
  serviceId String   @unique
  service   Service  @relation(name: "AVToService", fields: [serviceId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  dateTime  DateTime
  type      String
}

model Patient {
  id           String        @id @default(uuid())
  SSN          Int?          @unique
  nodeId       String?
  location     Node?         @relation(name: "PatientToNode", fields: [nodeId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  pcpId        String?
  pcp          Staff?        @relation(name: "PatientStaff_PCP", fields: [pcpId], references: [userId], onUpdate: Cascade, onDelete: SetNull)
  entryDate    DateTime      @default(now())
  firstName    String
  middleName   String?
  lastName     String
  dateOfBirth  DateTime
  phoneNumber  String?
  inTreatment  Boolean       @default(false)
  insurance    String?
  visits       Visit[]       @relation(name: "VisitPatient")
  appointments Appointment[] @relation(name: "AppointmentToPatient")
  userId       String?       @unique
  user         User?         @relation(name: "PatientUser", fields: [userId], references: [id])
}

model Appointment {
  id              String   @id @default(uuid())
  createdTime     DateTime @default(now())
  appointmentTime DateTime
  checkedIn       Boolean
  nodeId          String?
  location        Node?    @relation(name: "AppointmentToNode", fields: [nodeId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  patientId       String
  patient         Patient  @relation(name: "AppointmentToPatient", fields: [patientId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  visitId         String?  @unique
  visit           Visit?   @relation(name: "AppointmentVisit", fields: [visitId], references: [id])
  notes           String
}

model Visit {
  id          String       @id @default(uuid())
  notes       VisitNote[]  @relation(name: "VisitNoteToVisit")
  patientId   String
  patient     Patient      @relation(name: "VisitPatient", fields: [patientId], references: [id])
  visitTime   DateTime
  appointment Appointment? @relation("AppointmentVisit")
}

model VisitNote {
  id       String @id @default(uuid())
  type     String
  content  String
  authorId String
  author   Staff  @relation("VisitNoteToUser_Author", fields: [authorId], references: [userId])
  visitId  String
  visit    Visit  @relation(name: "VisitNoteToVisit", fields: [visitId], references: [id], onUpdate: Cascade, onDelete: Cascade)
}

model User {
  id      String   @id @default(uuid())
  sub     String   @unique
  email   String?
  role    Role?
  name    String
  patient Patient? @relation("PatientUser")
  staff   Staff?   @relation(name: "StaffUser")
}

model Staff {
  userId     String      @id
  user       User        @relation(name: "StaffUser", fields: [userId], references: [id])
  visitNotes VisitNote[] @relation(name: "VisitNoteToUser_Author")
  patients   Patient[]   @relation(name: "PatientStaff_PCP")
}

enum Role {
  patient
  staff
  admin
}
